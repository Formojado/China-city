<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEO-SCANNER SPECTRA</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --cyan: #00f3ff;
      --green: #00ff66;
      --red: #ff3366;
      --gold: #ffcc00;
      --bg: #111;
    }

    html, body { height: 100%; margin: 0; font-family: 'PingFang SC', sans-serif; background: var(--bg); overflow: hidden; }
    /* 地圖回歸明亮 */
    #map { height: 100vh; width: 100vw; z-index: 1; filter: contrast(1.1); }

    /* 頂部傳送帶 - 修正對稱性與切邊 */
    .header-ui { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100px; 
        background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
        z-index: 1001; pointer-events: none; border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex; align-items: center; justify-content: center;
    }
    .conveyor-viewport { width: 100%; height: 80px; overflow: hidden; position: relative; }
    .conveyor-belt { 
        display: flex; align-items: center; position: absolute; left: 50%; 
        transition: transform 0.5s cubic-bezier(0.2, 1, 0.3, 1);
        height: 100%;
    }
    
    .city-card { 
        min-width: 200px; text-align: center; opacity: 0.1; transform: scale(0.8); transition: 0.4s;
        display: flex; flex-direction: column; justify-content: center; height: 100%;
    }
    .city-card.active { 
        opacity: 1; transform: scale(1.1); 
        background: rgba(255, 255, 255, 0.05); border-radius: 10px;
    }
    
    .city-name-cn { font-size: 2.2rem; font-weight: 900; color: #fff; line-height: 1.2; }
    .city-name-en { font-size: 0.7rem; color: var(--cyan); letter-spacing: 2px; font-weight: bold; }

    /* 分數噴射動畫 */
    .score-burst {
        position: fixed; pointer-events: none; color: var(--gold); font-size: 3rem; font-weight: 900;
        z-index: 9999; text-shadow: 2px 2px 0px #000, -2px -2px 0px #000;
        animation: burst 1s ease-out forwards;
    }
    @keyframes burst {
        0% { transform: scale(0.5) translate(0,0); opacity: 0; }
        20% { opacity: 1; transform: scale(1.2) translate(0,-20px); }
        100% { transform: scale(1) translate(var(--tx), var(--ty)); opacity: 0; }
    }

    /* 按鈕與面板 */
    .stats-panel { 
        position: absolute; bottom: 20px; left: 20px; z-index: 1002; 
        background: rgba(0,0,0,0.8); padding: 10px 20px; border: 1px solid var(--cyan);
        display: flex; gap: 30px; border-radius: 5px;
    }
    .stat-val { font-family: monospace; font-size: 1.5rem; color: #fff; font-weight: bold; }
    
    #confirmContainer { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 1005; display: none; }
    .btn-confirm { 
        background: var(--cyan); color: #000; border: 2px solid #000; padding: 12px 50px; 
        font-size: 1.2rem; font-weight: 900; cursor: pointer; box-shadow: 0 0 20px var(--cyan);
    }

    .modal-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 2000; background: #000; }
    .start-box { text-align: center; border: 2px solid var(--cyan); padding: 40px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="header-ui"><div class="conveyor-viewport" id="viewport" style="display:none"><div class="conveyor-belt" id="belt"></div></div></div>
  
  <div class="stats-panel" id="statsPanel" style="display:none">
    <div><small style="color:var(--cyan)">SCORE</small><div id="score" class="stat-val">0</div></div>
    <div><small style="color:var(--cyan)">TARGETS</small><div class="stat-val"><span id="progress">0</span>/<span id="total">0</span></div></div>
  </div>

  <div id="confirmContainer"><button class="btn-confirm" id="confirmBtn">CONFIRM [SPACE]</button></div>

  <div id="startModal" class="modal-overlay">
    <div class="start-box">
      <h2 style="color:var(--cyan); margin:0 0 20px 0;">GEO-SCANNER</h2>
      <div style="font-size: 5rem; color:#fff; font-weight:900;" id="countDisplay">50</div>
      <input type="range" id="citySlider" min="5" max="342" value="50" style="width:100%; margin:20px 0;">
      <button id="startBtn" style="width:100%; padding:15px; background:var(--cyan); font-weight:900; cursor:pointer;">START</button>
    </div>
  </div>

  <script>
    // 數據庫部分 (請延用之前的 342 城市數據)
    const DB = [{cn:"北京",en:"BEIJING",coords:[39.9,116.4]},{cn:"上海",en:"SHANGHAI",coords:[31.2,121.4]},{cn:"廣州",en:"GUANGZHOU",coords:[23.1,113.2]},{cn:"深圳",en:"SHENZHEN",coords:[22.5,114.0]},{cn:"台北",en:"TAIPEI",coords:[25.0,121.5]} /* ...省略... */];

    let cities=[], idx=0, score=0, started=false, isProcessing=false;
    let currentClickPos = null, playerMarker = null, targetMarker = null, connectorLine = null;

    const map = L.map('map',{zoomControl:false, attributionControl:false}).setView([35, 105], 4);
    // 使用彩色明亮圖層
    L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}').addTo(map);

    const slider = document.getElementById('citySlider');
    slider.oninput = () => document.getElementById('countDisplay').textContent = slider.value;

    function startGame() {
      cities = [...DB].sort(()=>Math.random()-0.5).slice(0, parseInt(slider.value));
      document.getElementById('total').textContent = cities.length;
      document.getElementById('startModal').style.display = 'none';
      document.getElementById('viewport').style.display = 'block';
      document.getElementById('statsPanel').style.display = 'block';
      
      const belt = document.getElementById('belt');
      belt.innerHTML = cities.map(c => `<div class="city-card"><span class="city-name-cn">${c.cn}</span><span class="city-name-en">${c.en}</span></div>`).join('');
      started = true;
      updateConveyor();
    }

    function updateConveyor() {
      document.getElementById('belt').style.transform = `translateX(${-(idx * 200) - 100}px)`;
      document.querySelectorAll('.city-card').forEach((card, i) => card.classList.toggle('active', i === idx));
      document.getElementById('progress').textContent = idx + 1;
      isProcessing = false;
    }

    map.on('click', e => {
      if(!started || isProcessing) return;
      currentClickPos = e.latlng;
      if(playerMarker) map.removeLayer(playerMarker);
      // 玩家標記：紅底黑框，增加對比
      playerMarker = L.circleMarker(e.latlng, {
        radius: 9, color: '#000', fillColor: '#ff0000', weight: 4, fillOpacity: 1
      }).addTo(map);
      document.getElementById('confirmContainer').style.display = 'block';
    });

    function submitAnswer() {
      if(!started || !currentClickPos || isProcessing) return;
      isProcessing = true;
      document.getElementById('confirmContainer').style.display = 'none';

      const city = cities[idx];
      const dist = map.distance(currentClickPos, city.coords) / 1000;
      const points = Math.round(5000 * Math.pow(Math.E, -dist / 500));
      
      // 第一階段：放大點選處
      map.flyTo(currentClickPos, 7, { duration: 0.5 });

      setTimeout(() => {
        burstScore(points);
        // 第二階段：雷射綠標記正確位置
        targetMarker = L.circleMarker(city.coords, {
          radius: 10, color: '#000', fillColor: '#00ff00', weight: 4, fillOpacity: 1
        }).addTo(map);
        connectorLine = L.polyline([currentClickPos, city.coords], {color: '#000', weight: 2, dashArray: '5, 5'}).addTo(map);
        
        score += points;
        document.getElementById('score').textContent = score;
        // 平移到目標
        map.flyTo(city.coords, 8, { duration: 0.8 });
      }, 600);

      setTimeout(() => {
        idx++;
        if(playerMarker) map.removeLayer(playerMarker);
        if(targetMarker) map.removeLayer(targetMarker);
        if(connectorLine) map.removeLayer(connectorLine);
        if(idx < cities.length) { 
            updateConveyor(); 
            map.flyTo([35, 105], 4, { duration: 0.6 }); 
        } else { alert("Mission Complete! Score: " + score); location.reload(); }
      }, 2600);
    }

    function burstScore(pts) {
      const screenPos = map.latLngToContainerPoint(currentClickPos);
      const div = document.createElement('div');
      div.className = 'score-burst';
      div.style.left = screenPos.x + 'px';
      div.style.top = screenPos.y + 'px';
      div.style.setProperty('--tx', (Math.random() * 160 - 80) + 'px');
      div.style.setProperty('--ty', (-120 - Math.random() * 50) + 'px');
      div.textContent = `+${pts}`;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 1000);
    }

    window.addEventListener('keydown', e => {
      if(e.code === 'Space' && document.getElementById('confirmContainer').style.display === 'block') {
        e.preventDefault(); submitAnswer();
      }
    });

    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('confirmBtn').onclick = submitAnswer;
  </script>
</body>
</html>
