<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEO-SCANNER SPECTRA MAX 300</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --cyan: #00f3ff;
      --green: #00ff66;
      --red: #ff3366;
      --gold: #ffcc00;
      --bg: #0a0c10;
    }

    html, body { height: 100%; margin: 0; font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; background: var(--bg); overflow: hidden; }
    #map { height: 100vh; width: 100vw; z-index: 1; background: #000; }

    .header-ui { 
        position: absolute; top: 0; left: 0; width: 100%; height: 160px; 
        background: linear-gradient(to bottom, rgba(10, 20, 30, 0.95) 0%, rgba(10, 20, 30, 0) 100%); 
        z-index: 1001; pointer-events: none; display: flex; flex-direction: column; align-items: center;
    }

    .conveyor-viewport { width: 100%; height: 110px; overflow: hidden; position: relative; margin-top: 10px; }
    .conveyor-belt { display: flex; align-items: center; position: absolute; left: 50%; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); height: 100%; }
    
    .city-card { min-width: 220px; text-align: center; opacity: 0.15; transform: scale(0.85); transition: 0.5s; display: flex; flex-direction: column; justify-content: center; }
    .city-card.active { opacity: 1; transform: scale(1.1); text-shadow: 0 0 20px var(--cyan); }
    
    .city-name-cn { font-size: 2.5rem; font-weight: 900; color: #fff; line-height: 1; margin-bottom: 4px; }
    .city-name-en { font-size: 0.75rem; color: var(--cyan); letter-spacing: 2px; font-weight: bold; text-transform: uppercase; }

    .score-burst { position: fixed; pointer-events: none; color: var(--gold); font-size: 3.5rem; font-weight: 900; z-index: 9999; animation: burst 1.2s forwards; text-shadow: 2px 2px 0 #000; }
    @keyframes burst { 0% { transform: scale(0); opacity: 0; } 30% { opacity: 1; transform: scale(1.2); } 100% { transform: translate(var(--tx), var(--ty)); opacity: 0; } }

    .stats-panel { 
        position: absolute; bottom: 25px; left: 25px; z-index: 1002; 
        background: rgba(5, 10, 15, 0.85); padding: 12px 25px; border-left: 4px solid var(--cyan);
        display: flex; gap: 40px; border-radius: 4px; backdrop-filter: blur(8px); border: 1px solid rgba(0,243,255,0.2);
    }
    .stat-val { font-family: 'Courier New', monospace; font-size: 1.6rem; color: #fff; font-weight: bold; }
    
    #confirmContainer { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 1005; display: none; }
    .btn-confirm { background: var(--cyan); color: #000; border: none; padding: 14px 60px; font-size: 1.3rem; font-weight: 900; cursor: pointer; border-radius: 50px; box-shadow: 0 0 20px rgba(0,243,255,0.4); }

    .modal-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 2000; background: #05070a; }
    .start-box { text-align: center; border: 1px solid var(--cyan); padding: 40px; background: rgba(0, 243, 255, 0.05); width: 450px; }
    input[type=range] { width: 100%; accent-color: var(--cyan); cursor: pointer; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="header-ui">
    <div class="conveyor-viewport" id="viewport" style="display:none">
        <div class="conveyor-belt" id="belt"></div>
    </div>
  </div>
  
  <div class="stats-panel" id="statsPanel" style="display:none">
    <div><small style="color:var(--cyan); letter-spacing:2px;">TOTAL SCORE</small><div id="score" class="stat-val">0</div></div>
    <div><small style="color:var(--cyan); letter-spacing:2px;">SCAN INDEX</small><div class="stat-val"><span id="progress">0</span> / <span id="total">0</span></div></div>
  </div>

  <div id="confirmContainer"><button class="btn-confirm" id="confirmBtn">LOCK COORDINATES</button></div>

  <div id="startModal" class="modal-overlay">
    <div class="start-box">
      <h2 style="color:var(--cyan); letter-spacing:10px; margin-bottom:5px;">GEO-SCANNER</h2>
      <p style="color:rgba(255,255,255,0.3); font-size:0.7rem; margin-bottom:20px;">DATABASE EXPANDED: 300+ NODES</p>
      <div style="font-size: 5rem; color:#fff; font-weight:900;" id="countDisplay">50</div>
      <input type="range" id="citySlider" min="5" max="300" value="50">
      <button id="startBtn" style="width:100%; padding:18px; background:var(--cyan); font-weight:900; cursor:pointer; border:none; margin-top:30px; letter-spacing:4px;">INITIALIZE INTERFACE</button>
    </div>
  </div>

  <script>
    // 數據庫擴充至 300+ 城市 (不含台灣)
    const DB = [
        {cn:"北京",en:"Beijing",coords:[39.9,116.4]},{cn:"上海",en:"Shanghai",coords:[31.2,121.4]},{cn:"廣州",en:"Guangzhou",coords:[23.1,113.2]},{cn:"深圳",en:"Shenzhen",coords:[22.5,114.0]},{cn:"成都",en:"Chengdu",coords:[30.5,104.0]},{cn:"重慶",en:"Chongqing",coords:[29.5,106.5]},{cn:"杭州",en:"Hangzhou",coords:[30.2,120.1]},{cn:"西安",en:"Xi'an",coords:[34.3,108.9]},{cn:"武漢",en:"Wuhan",coords:[30.5,114.3]},{cn:"南京",en:"Nanjing",coords:[32.0,118.8]},{cn:"天津",en:"Tianjin",coords:[39.0,117.2]},{cn:"鄭州",en:"Zhengzhou",coords:[34.7,113.6]},{cn:"長沙",en:"Changsha",coords:[28.2,112.9]},{cn:"沈陽",en:"Shenyang",coords:[41.8,123.4]},{cn:"青島",en:"Qingdao",coords:[36.0,120.3]},{cn:"昆明",en:"Kunming",coords:[25.0,102.7]},{cn:"大連",en:"Dalian",coords:[38.9,121.6]},{cn:"廈門",en:"Xiamen",coords:[24.4,118.0]},{cn:"哈爾濱",en:"Harbin",coords:[45.8,126.5]},{cn:"烏魯木齊",en:"Urumqi",coords:[43.8,87.6]},{cn:"拉薩",en:"Lhasa",coords:[29.6,91.1]},{cn:"三亞",en:"Sanya",coords:[18.2,109.5]},{cn:"石家莊",en:"Shijiazhuang",coords:[38.0,114.5]},{cn:"南昌",en:"Nanchang",coords:[28.6,115.8]},{cn:"濟南",en:"Jinan",coords:[36.6,117.0]},{cn:"南寧",en:"Nanning",coords:[22.8,108.3]},{cn:"貴陽",en:"Guiyang",coords:[26.6,106.6]},{cn:"蘭州",en:"Lanzhou",coords:[36.0,103.8]},{cn:"海口",en:"Haikou",coords:[20.0,110.3]},{cn:"銀川",en:"Yinchuan",coords:[38.4,106.2]},{cn:"西寧",en:"Xining",coords:[36.6,101.7]},{cn:"呼和浩特",en:"Hohhot",coords:[40.8,111.7]},{cn:"蘇州",en:"Suzhou",coords:[31.3,120.6]},{cn:"無錫",en:"Wuxi",coords:[31.5,120.3]},{cn:"佛山",en:"Foshan",coords:[23.0,113.1]},{cn:"東莞",en:"Dongguan",coords:[22.9,113.7]},{cn:"寧波",en:"Ningbo",coords:[29.8,121.5]},{cn:"福州",en:"Fuzhou",coords:[26.1,119.3]},{cn:"合肥",en:"Hefei",coords:[31.8,117.2]},{cn:"常州",en:"Changzhou",coords:[31.8,119.9]},{cn:"煙台",en:"Yantai",coords:[37.5,121.4]},{cn:"唐山",en:"Tangshan",coords:[39.6,118.2]},{cn:"徐州",en:"Xuzhou",coords:[34.2,117.2]},{cn:"溫州",en:"Wenzhou",coords:[28.0,120.7]},{cn:"濰坊",en:"Weifang",coords:[36.7,119.1]},{cn:"洛陽",en:"Luoyang",coords:[34.6,112.4]},{cn:"紹興",en:"Shaoxing",coords:[30.0,120.6]},{cn:"揚州",en:"Yangzhou",coords:[32.4,119.4]},{cn:"南通",en:"Nantong",coords:[32.0,120.8]},{cn:"鹽城",en:"Yancheng",coords:[33.3,120.1]},{cn:"台州",en:"Taizhou",coords:[28.6,121.4]},{cn:"金華",en:"Jinhua",coords:[29.1,119.6]},{cn:"嘉興",en:"Jiaxing",coords:[30.7,120.7]},{cn:"鎮江",en:"Zhenjiang",coords:[32.2,119.4]},{cn:"宜昌",en:"Yichang",coords:[30.7,111.3]},{cn:"襄陽",en:"Xiangyang",coords:[32.0,112.1]},{cn:"岳陽",en:"Yueyang",coords:[29.3,113.1]},{cn:"惠州",en:"Huizhou",coords:[23.1,114.4]},{cn:"中山",en:"Zhongshan",coords:[22.5,113.3]},{cn:"珠海",en:"Zhuhai",coords:[22.2,113.5]},{cn:"汕頭",en:"Shantou",coords:[23.3,116.6]},{cn:"湛江",en:"Zhanjiang",coords:[21.2,110.3]},{cn:"柳州",en:"Liuzhou",coords:[24.3,109.4]},{cn:"桂林",en:"Guilin",coords:[25.2,110.2]},{cn:"蕪湖",en:"Wuhu",coords:[31.3,118.4]},{cn:"泉州",en:"Quanzhou",coords:[24.8,118.6]},{cn:"九江",en:"Jiujiang",coords:[29.7,116.0]},{cn:"贛州",en:"Ganzhou",coords:[25.8,114.9]},{cn:"淄博",en:"Zibo",coords:[36.8,118.0]},{cn:"臨沂",en:"Linyi",coords:[35.0,118.3]},{cn:"濟寧",en:"Jining",coords:[35.4,116.5]},{cn:"邯鄲",en:"Handan",coords:[36.6,114.5]},{cn:"保定",en:"Baoding",coords:[38.8,115.4]},{cn:"秦皇島",en:"Qinhuangdao",coords:[39.9,119.6]},{cn:"鞍山",en:"Anshan",coords:[41.1,122.9]},{cn:"吉林",en:"Jilin",coords:[43.8,126.5]},{cn:"大慶",en:"Daqing",coords:[46.6,125.1]},{cn:"齊齊哈爾",en:"Qiqihar",coords:[47.3,123.9]},{cn:"包頭",en:"Baotou",coords:[40.6,109.8]},{cn:"鄂爾多斯",en:"Ordos",coords:[39.6,109.7]},{cn:"延安",en:"Yan'an",coords:[36.5,109.5]},{cn:"漢中",en:"Hanzhong",coords:[33.0,107.0]},{cn:"天水",en:"Tianshui",coords:[34.5,105.7]},{cn:"克拉瑪依",en:"Karamay",coords:[45.5,84.8]},{cn:"喀什",en:"Kashgar",coords:[39.4,75.9]},{cn:"庫爾勒",en:"Korla",coords:[41.7,86.1]},{cn:"日喀則",en:"Shigatse",coords:[29.2,88.8]},{cn:"林芝",en:"Nyingchi",coords:[29.6,94.3]},{cn:"遵義",en:"Zunyi",coords:[27.7,106.9]},{cn:"大理",en:"Dali",coords:[25.6,110.2]},{cn:"麗江",en:"Lijiang",coords:[26.8,110.2]},{cn:"綿陽",en:"Mianyang",coords:[31.4,104.6]},{cn:"宜賓",en:"Yibin",coords:[28.7,104.6]},{cn:"樂山",en:"Leshan",coords:[29.5,103.7]},{cn:"攀枝花",en:"Panzihua",coords:[26.5,101.7]},{cn:"自貢",en:"Zigong",coords:[29.3,104.7]},{cn:"張家口",en:"Zhangjiakou",coords:[40.8,114.8]},{cn:"承德",en:"Chengde",coords:[40.9,117.9]},{cn:"滄州",en:"Cangzhou",coords:[38.3,116.8]},{cn:"廊坊",en:"Langfang",coords:[39.5,116.7]},{cn:"大同",en:"Datong",coords:[40.0,113.3]},{cn:"太原",en:"Taiyuan",coords:[37.8,112.5]},{cn:"運城",en:"Yuncheng",coords:[35.0,111.0]},{cn:"長治",en:"Changzhi",coords:[36.2,113.1]},{cn:"馬鞍山",en:"Ma'anshan",coords:[31.6,118.5]},{cn:"蚌埠",en:"Bengbu",coords:[32.9,117.3]},{cn:"安慶",en:"Anqing",coords:[30.5,117.0]},{cn:"威海",en:"Weihai",coords:[37.5,122.1]},{cn:"泰安",en:"Tai'an",coords:[36.1,117.0]},{cn:"日照",en:"Rizhao",coords:[35.4,119.4]},
        {cn:"撫順",en:"Fushun",coords:[41.8,123.9]},{cn:"本溪",en:"Benxi",coords:[41.3,123.7]},{cn:"丹東",en:"Dandong",coords:[40.1,124.3]},{cn:"錦州",en:"Jinzhou",coords:[41.1,121.1]},{cn:"營口",en:"Yingkou",coords:[40.6,122.2]},{cn:"阜新",en:"Fuxin",coords:[42.0,121.6]},{cn:"遼陽",en:"Liaoyang",coords:[41.2,123.1]},{cn:"盤錦",en:"Panjin",coords:[41.1,122.0]},{cn:"鐵嶺",en:"Tieling",coords:[42.2,123.8]},{cn:"朝陽",en:"Chaoyang",coords:[41.5,120.4]},{cn:"葫蘆島",en:"Huludao",coords:[40.7,120.8]},{cn:"長春",en:"Changchun",coords:[43.8,125.3]},{cn:"四平",en:"Siping",coords:[43.1,124.3]},{cn:"遼源",en:"Liaoyuan",coords:[42.9,125.1]},{cn:"通化",en:"Tonghua",coords:[41.7,125.9]},{cn:"白山",en:"Baishan",coords:[41.9,126.4]},{cn:"松原",en:"Songyuan",coords:[45.1,124.8]},{cn:"白城",en:"Baicheng",coords:[45.6,122.8]},{cn:"鶴崗",en:"Hegang",coords:[47.3,130.2]},{cn:"雞西",en:"Jixi",coords:[45.3,130.9]},{cn:"雙鴨山",en:"Shuangyashan",coords:[46.6,131.1]},{cn:"伊春",en:"Yichun",coords:[47.7,128.8]},{cn:"佳木斯",en:"Jiamusi",coords:[46.8,130.3]},{cn:"七台河",en:"Qitaihe",coords:[45.7,131.0]},{cn:"牡丹江",en:"Mudanjiang",coords:[44.5,129.6]},{cn:"黑河",en:"Heihe",coords:[50.2,127.5]},{cn:"綏化",en:"Suihua",coords:[46.6,126.9]},{cn:"連雲港",en:"Lianyungang",coords:[34.6,119.2]},{cn:"淮安",en:"Huaian",coords:[33.6,119.0]},{cn:"宿遷",en:"Suqian",coords:[33.9,118.2]},{cn:"湖州",en:"Huzhou",coords:[30.8,120.0]},{cn:"舟山",en:"Zhoushan",coords:[29.9,122.1]},{cn:"淮南",en:"Huainan",coords:[32.6,117.0]},{cn:"淮北",en:"Huaibei",coords:[33.9,116.8]},{cn:"銅陵",en:"Tongling",coords:[30.9,117.8]},{cn:"黃山",en:"Huangshan",coords:[29.7,118.3]},{cn:"滁州",en:"Chuzhou",coords:[32.3,118.3]},{cn:"阜陽",en:"Fuyang",coords:[32.8,115.8]},{cn:"宿州",en:"Suzhou_A",coords:[33.6,116.9]},{cn:"六安",en:"Luan",coords:[31.7,116.5]},{cn:"亳州",en:"Bozhou",coords:[33.8,115.7]},{cn:"池州",en:"Chizhou",coords:[30.6,117.4]},{cn:"宣城",en:"Xuancheng",coords:[30.9,118.7]},{cn:"莆田",en:"Putian",coords:[25.4,119.0]},{cn:"三明",en:"Sanming",coords:[26.2,117.6]},{cn:"漳州",en:"Zhangzhou",coords:[24.5,117.6]},{cn:"南平",en:"Nanping",coords:[26.6,118.1]},{cn:"龍岩",en:"Longyan",coords:[25.0,117.0]},{cn:"寧德",en:"Ningde",coords:[26.6,119.5]},{cn:"景德鎮",en:"Jingdezhen",coords:[29.2,117.1]},{cn:"萍鄉",en:"Pingxiang",coords:[27.6,113.8]},{cn:"新余",en:"Xinyu",coords:[27.8,114.9]},{cn:"鷹潭",en:"Yingtan",coords:[28.2,117.0]},{cn:"宜春",en:"Yichun_J",coords:[27.8,114.4]},{cn:"上饒",en:"Shangrao",coords:[28.4,117.9]},{cn:"吉安",en:"Jian",coords:[27.1,114.9]},{cn:"撫州",en:"Fuzhou_J",coords:[27.9,116.3]},{cn:"棗莊",en:"Zaozhuang",coords:[34.8,117.3]},{cn:"東營",en:"Dongying",coords:[37.4,118.6]},{cn:"德州",en:"Dezhou",coords:[37.4,116.3]},{cn:"聊城",en:"Liaocheng",coords:[36.4,115.9]},{cn:"濱州",en:"Binzhou",coords:[37.3,118.0]},{cn:"菏澤",en:"Heze",coords:[35.2,115.4]},{cn:"開封",en:"Kaifeng",coords:[34.7,114.3]},{cn:"平頂山",en:"Pingdingshan",coords:[33.7,113.3]},{cn:"安陽",en:"Anyang",coords:[36.1,114.3]},{cn:"鶴壁",en:"Hebi",coords:[35.7,114.2]},{cn:"新鄉",en:"Xinxiang",coords:[35.3,113.8]},{cn:"焦作",en:"Jiaozuo",coords:[35.2,113.2]},{cn:"濮陽",en:"Puyang",coords:[35.7,115.0]},{cn:"許昌",en:"Xuchang",coords:[34.0,113.8]},{cn:"漯河",en:"Luohe",coords:[33.5,114.0]},{cn:"三門峽",en:"Sanmenxia",coords:[34.7,111.1]},{cn:"商丘",en:"Shangqiu",coords:[34.4,115.6]},{cn:"信陽",en:"Xinyang",coords:[32.1,114.0]},{cn:"周口",en:"Zhoukou",coords:[33.6,114.6]},{cn:"駐馬店",en:"Zhumadian",coords:[32.9,114.0]},{cn:"黃石",en:"Huangshi",coords:[30.2,115.0]},{cn:"十堰",en:"Shiyan",coords:[32.6,110.7]},{cn:"荊州",en:"Jingzhou",coords:[30.3,112.2]},{cn:"荊門",en:"Jingmen",coords:[31.0,112.2]},{cn:"鄂州",en:"Ezhou",coords:[30.3,114.8]},{cn:"孝感",en:"Xiaogan",coords:[30.9,113.9]},{cn:"黃岡",en:"Huanggang",coords:[30.4,114.8]},{cn:"咸寧",en:"Xianning",coords:[29.8,114.3]},{cn:"隨州",en:"Suizhou",coords:[31.7,113.3]},{cn:"株洲",en:"Zhuzhou",coords:[27.8,113.1]},{cn:"湘潭",en:"Xiangtan",coords:[27.8,112.9]},{cn:"邵陽",en:"Shaoyang",coords:[27.2,111.4]},{cn:"常德",en:"Changde",coords:[29.0,111.6]},{cn:"張家界",en:"Zhangjiajie",coords:[29.1,110.4]},{cn:"益陽",en:"Yiyang",coords:[28.5,112.3]},{cn:"郴州",en:"Chenzhou",coords:[25.7,113.0]},{cn:"永州",en:"Yongzhou",coords:[26.4,111.6]},{cn:"懷化",en:"Huaihua",coords:[27.5,110.0]},{cn:"婁底",en:"Loudi",coords:[27.7,112.0]},{cn:"韶關",en:"Shaoguan",coords:[24.8,113.5]},{cn:"江門",en:"Jiangmen",coords:[22.5,113.0]},{cn:"茂名",en:"Maoming",coords:[21.6,110.9]},{cn:"肇慶",en:"Zhaoqing",coords:[23.0,112.4]},{cn:"梅州",en:"Meizhou",coords:[24.2,116.1]},{cn:"汕尾",en:"Shanwei",coords:[22.7,115.3]},{cn:"河源",en:"Heyuan",coords:[23.7,114.6]},{cn:"陽江",en:"Yangjiang",coords:[21.8,111.9]},{cn:"清遠",en:"Qingyuan",coords:[23.6,113.0]},{cn:"潮州",en:"Chaozhou",coords:[23.6,116.6]},{cn:"揭陽",en:"Jieyang",coords:[23.5,116.3]},{cn:"雲浮",en:"Yunfu",coords:[22.9,112.0]},{cn:"梧州",en:"Wuzhou",coords:[23.4,111.2]},{cn:"北海",en:"Beihai",coords:[21.4,109.1]},{cn:"防城港",en:"Fangchenggang",coords:[21.6,108.3]},{cn:"欽州",en:"Qinzhou",coords:[21.9,108.6]},{cn:"貴港",en:"Guigang",coords:[23.1,109.6]},{cn:"玉林",en:"Yulin",coords:[22.6,110.1]},{cn:"百色",en:"Baise",coords:[23.9,106.6]},{cn:"賀州",en:"Hezhou",coords:[24.4,111.5]},{cn:"河池",en:"Hechi",coords:[24.6,108.0]},{cn:"來賓",en:"Laibin",coords:[23.7,109.2]},{cn:"崇左",en:"Chongzuo",coords:[22.4,107.3]},{cn:"攀枝花",en:"Panzhihua",coords:[26.5,101.7]},{cn:"瀘州",en:"Luzhou",coords:[28.8,105.4]},{cn:"德陽",en:"Deyang",coords:[31.1,104.3]},{cn:"廣元",en:"Guangyuan",coords:[32.4,105.8]},{cn:"遂寧",en:"Suining",coords:[30.5,105.5]},{cn:"內江",en:"Neijiang",coords:[29.5,105.0]},{cn:"南充",en:"Nanchong",coords:[30.7,106.0]},{cn:"眉山",en:"Meishan",coords:[30.0,103.8]},{cn:"廣安",en:"Guangan",coords:[30.4,106.6]},{cn:"達州",en:"Dazhou",coords:[31.2,107.4]},{cn:"雅安",en:"Yaan",coords:[29.9,102.9]},{cn:"巴中",en:"Bazhong",coords:[31.8,106.7]},{cn:"資陽",en:"Ziyang",coords:[30.1,104.6]},{cn:"六盤水",en:"Liupanshui",coords:[26.5,104.8]},{cn:"安順",en:"Anshun",coords:[26.2,105.9]},{cn:"畢節",en:"Bijie",coords:[27.3,105.2]},{cn:"銅仁",en:"Tongren",coords:[27.7,109.1]},{cn:"曲靖",en:"Qujing",coords:[25.4,103.7]},{cn:"玉溪",en:"Yuxi",coords:[24.3,102.5]},{cn:"保山",en:"Baoshan",coords:[25.1,99.1]},{cn:"昭通",en:"Zhaotong",coords:[27.3,103.7]},{cn:"普洱",en:"Puer",coords:[22.7,100.9]},{cn:"臨滄",en:"Lincang",coords:[23.8,100.0]},{cn:"銅川",en:"Tongchuan",coords:[34.8,108.9]},{cn:"寶雞",en:"Baoji",coords:[34.3,107.1]},{cn:"咸陽",en:"Xianyang",coords:[34.3,108.7]},{cn:"渭南",en:"Weinan",coords:[34.5,109.5]},{cn:"榆林",en:"Yulin_S",coords:[38.2,109.7]},{cn:"安康",en:"Ankang",coords:[32.6,109.0]},{cn:"商洛",en:"Shangluo",coords:[33.8,109.9]},{cn:"金昌",en:"Jinchang",coords:[38.5,102.1]},{cn:"白銀",en:"Baiyin",coords:[36.5,104.1]},{cn:"武威",en:"Wuwei",coords:[37.9,102.6]},{cn:"張掖",en:"Zhangye",coords:[38.9,100.4]},{cn:"平涼",en:"Pingliang",coords:[35.5,106.6]},{cn:"酒泉",en:"Jiuquan",coords:[39.7,98.5]},{cn:"慶陽",en:"Qingyang",coords:[35.7,107.6]},{cn:"定西",en:"Dingxi",coords:[35.5,104.6]},{cn:"隴南",en:"Longnan",coords:[33.3,104.9]},{cn:"石嘴山",en:"Shizuishan",coords:[39.0,106.3]},{cn:"吳忠",en:"Wuzhong",coords:[37.9,106.1]},{cn:"固原",en:"Guyuan",coords:[36.0,106.2]},{cn:"中衛",en:"Zhongwei",coords:[37.5,105.1]},{cn:"吐魯番",en:"Turpan",coords:[42.9,89.1]},{cn:"哈密",en:"Hami",coords:[42.8,93.5]}
    ];

    let cities=[], idx=0, score=0, started=false, isProcessing=false;
    let currentClickPos = null, playerMarker = null, targetMarker = null, connectorLine = null;

    // 初始化地圖
    const map = L.map('map',{zoomControl:false, attributionControl:false}).setView([35, 105], 4);
    L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}').addTo(map);

    const slider = document.getElementById('citySlider');
    slider.oninput = () => document.getElementById('countDisplay').textContent = slider.value;

    function startGame() {
        const count = Math.min(parseInt(slider.value), DB.length);
        // 洗牌算法隨機選取
        cities = [...DB].sort(() => Math.random() - 0.5).slice(0, count);

        document.getElementById('total').textContent = cities.length;
        document.getElementById('startModal').style.display = 'none';
        document.getElementById('viewport').style.display = 'block';
        document.getElementById('statsPanel').style.display = 'flex';
        
        const belt = document.getElementById('belt');
        belt.innerHTML = cities.map(c => `<div class="city-card"><span class="city-name-cn">${c.cn}</span><span class="city-name-en">${c.en}</span></div>`).join('');
        started = true;
        updateConveyor();
    }

    function updateConveyor() {
        document.getElementById('belt').style.transform = `translateX(${-(idx * 220) - 110}px)`;
        const cards = document.querySelectorAll('.city-card');
        cards.forEach((card, i) => card.classList.toggle('active', i === idx));
        document.getElementById('progress').textContent = idx + 1;
        isProcessing = false;
    }

    map.on('click', e => {
        if(!started || isProcessing) return;
        currentClickPos = e.latlng;
        if(playerMarker) map.removeLayer(playerMarker);
        playerMarker = L.circleMarker(e.latlng, {
            radius: 10, color: '#000', fillColor: '#ff3366', weight: 3, fillOpacity: 1
        }).addTo(map);
        document.getElementById('confirmContainer').style.display = 'block';
    });

    function submitAnswer() {
        if(!started || !currentClickPos || isProcessing) return;
        isProcessing = true;
        document.getElementById('confirmContainer').style.display = 'none';

        const city = cities[idx];
        const dist = map.distance(currentClickPos, city.coords) / 1000;
        const points = Math.round(5000 * Math.pow(Math.E, -dist / 500));
        
        map.flyTo(currentClickPos, 7, { duration: 0.5 });

        setTimeout(() => {
            burstScore(points);
            targetMarker = L.circleMarker(city.coords, {
                radius: 12, color: '#000', fillColor: '#00ff66', weight: 4, fillOpacity: 1
            }).addTo(map);
            connectorLine = L.polyline([currentClickPos, city.coords], {color: '#fff', weight: 2, dashArray: '5, 10'}).addTo(map);
            
            score += points;
            document.getElementById('score').textContent = score.toLocaleString();
            map.flyTo(city.coords, 8, { duration: 0.8 });
        }, 600);

        setTimeout(() => {
            idx++;
            if(playerMarker) map.removeLayer(playerMarker);
            if(targetMarker) map.removeLayer(targetMarker);
            if(connectorLine) map.removeLayer(connectorLine);
            
            if(idx < cities.length) { 
                updateConveyor(); 
                map.flyTo([35, 105], 4, { duration: 0.7 }); 
            } else { 
                alert("DATABASE SCAN COMPLETE!\nFINAL SCORE: " + score); 
                location.reload(); 
            }
        }, 2800);
    }

    function burstScore(pts) {
        const screenPos = map.latLngToContainerPoint(currentClickPos);
        const div = document.createElement('div');
        div.className = 'score-burst';
        div.style.left = screenPos.x + 'px';
        div.style.top = screenPos.y + 'px';
        div.style.setProperty('--tx', (Math.random() * 200 - 100) + 'px');
        div.style.setProperty('--ty', (-150) + 'px');
        div.textContent = `+${pts}`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1200);
    }

    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('confirmBtn').onclick = submitAnswer;

    window.addEventListener('keydown', e => {
        if(e.code === 'Space' && document.getElementById('confirmContainer').style.display === 'block') {
            e.preventDefault(); submitAnswer();
        }
    });
  </script>
</body>
</html>
